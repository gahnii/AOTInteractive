<!doctype html><html lang="en"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>104th Cadet Evaluation</title>
<style>
:root{--ink:#1f2b2a;--accent:#6b1f1f;--mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;overflow:hidden;color:var(--ink);font-family:var(--mono)}
.bg{position:fixed;inset:0;background:url("parchment.jpg") center/cover no-repeat;transition:filter 1.2s ease}
.bg:after{content:"";position:absolute;inset:0;background:
radial-gradient(900px 520px at 50% 45%,transparent 55%,rgba(0,0,0,.22)),
radial-gradient(1200px 900px at 50% 50%,transparent 60%,rgba(0,0,0,.18));
opacity:.35;transition:opacity 1.2s ease}
body.night .bg{filter:brightness(.42) saturate(.85) contrast(1.05)}
body.night .bg:after{opacity:.55}

.blood{position:fixed;inset:0;pointer-events:none;opacity:0;transition:opacity .7s ease}
.blood img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:saturate(1.2) contrast(1.05)}
.vignette{position:fixed;inset:0;pointer-events:none;opacity:0;transition:opacity .7s ease;background:radial-gradient(800px 520px at 50% 45%,transparent 55%,rgba(0,0,0,.55),rgba(0,0,0,.78))}
.blackout{position:fixed;inset:0;background:#07080b;opacity:0;pointer-events:none;transition:opacity 1.1s ease;z-index:40}
.blackout.on{opacity:1}

.top{position:fixed;left:0;right:0;top:0;display:flex;justify-content:space-between;gap:12px;padding:18px 28px;pointer-events:none;z-index:5}
.h1{font-weight:800;letter-spacing:.6px;text-transform:uppercase;font-size:18px}
.sub{opacity:.75;font-size:12px;margin-top:6px}
.stamp{font-size:12px;text-align:right;border:1px dashed rgba(0,0,0,.28);border-radius:10px;padding:10px 12px;background:rgba(255,255,255,.18)}
.stamp b{color:var(--accent)}
.settingsBtn{pointer-events:auto;align-self:flex-start;margin-left:12px;width:34px;height:34px;border-radius:12px;border:1px solid rgba(0,0,0,.22);background:rgba(255,255,255,.18);cursor:pointer;font:16px var(--mono);display:grid;place-items:center}
.settingsBtn:active{transform:translateY(1px)}

.wrap{position:relative;height:100%;display:grid;align-items:center;padding:90px 28px 190px}
.text{max-width:920px;font-size:16px;line-height:1.95;margin:0 auto}
.caret{display:inline-block;width:9px;height:18px;vertical-align:-3px;margin-left:4px;background:rgba(31,43,42,.65);animation:blink 1.1s steps(1) infinite}
@keyframes blink{50%{opacity:0}}
.hint{font-size:12px;opacity:.65;margin-top:10px}

.bottom{position:fixed;left:50%;transform:translateX(-50%);bottom:0;width:min(920px,92vw);padding:18px 0 22px;display:grid;gap:12px;justify-items:stretch;z-index:6}
.box{border:1px solid rgba(0,0,0,.22);border-radius:10px;background:rgba(255,255,255,.08);backdrop-filter:blur(2px);padding:12px 14px}
.label{opacity:.8;font-size:12px;margin-bottom:8px;text-transform:uppercase;letter-spacing:.4px;display:flex;justify-content:space-between;gap:12px}
.pill{border:1px solid rgba(0,0,0,.18);border-radius:999px;padding:2px 8px;font-size:11px;opacity:.75}
.row{display:flex;gap:10px;align-items:center}
input{flex:1;font:16px var(--mono);border:0;outline:0;background:transparent;color:var(--ink)}
.btn{font:12px var(--mono);text-transform:uppercase;padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,.22);background:rgba(255,255,255,.18);cursor:pointer}
.btn:disabled{opacity:.45;cursor:not-allowed}
.hidden{display:none}

#out .ln{display:block;white-space:pre-wrap}
#out .dim{opacity:.35}
#out .fade{opacity:.18}
#out .who{font-weight:900}
#out .pick{color:var(--accent);font-weight:800}

.choices{display:grid;grid-template-columns:1fr;gap:10px}
.choice{text-align:left}

.modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.25);backdrop-filter:blur(2px);z-index:50}
.modal.show{display:grid}
.panel{width:min(560px,92vw);border:1px solid rgba(0,0,0,.22);border-radius:14px;background:rgba(255,255,255,.16);padding:14px 14px 12px;box-shadow:0 20px 60px rgba(0,0,0,.22)}
.panel h2{margin:0 0 10px;font:800 14px var(--mono);letter-spacing:.6px;text-transform:uppercase;display:flex;justify-content:space-between;gap:12px}
.close{font:12px var(--mono);text-transform:uppercase;padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,.22);background:rgba(255,255,255,.18);cursor:pointer}
.opt{display:grid;gap:10px}
.row2{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 10px;border-radius:12px;border:1px solid rgba(0,0,0,.18);background:rgba(255,255,255,.10)}
.row2 small{opacity:.7;display:block;margin-top:4px;line-height:1.35}
.sel{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.chip{font:12px var(--mono);padding:7px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.20);background:rgba(255,255,255,.14);cursor:pointer}
.chip.on{border-color:rgba(107,31,31,.55);background:rgba(107,31,31,.12)}
.tog{display:flex;gap:10px;align-items:center}
.tog input{width:18px;height:18px}
.note{opacity:.75;font-size:12px;line-height:1.5;margin-top:10px}

/* ===== STATS MODAL ===== */
.statsGrid{display:grid;gap:10px}
.statRow{display:flex;align-items:center;justify-content:space-between;gap:12px;
  padding:10px 10px;border-radius:12px;border:1px solid rgba(0,0,0,.18);
  background:rgba(255,255,255,.10)
}
.statRow .k{font-weight:900;text-transform:uppercase;letter-spacing:.4px;font-size:12px;opacity:.85}
.statRow .v{font-weight:900}
.statRow small{display:block;opacity:.7;font-weight:400;line-height:1.35;margin-top:4px}
.badge{border:1px solid rgba(0,0,0,.18);border-radius:999px;padding:4px 10px;font-size:12px;background:rgba(255,255,255,.12)}
.badge.clean{border-color:rgba(0,0,0,.18)}
.badge.updated{border-color:rgba(107,31,31,.38);background:rgba(107,31,31,.08)}
.badge.flagged{border-color:rgba(107,31,31,.62);background:rgba(107,31,31,.12)}

@media (prefers-reduced-motion:reduce){.caret{animation:none}.blood,.vignette,.bg,.blackout{transition:none}}
</style></head><body>
<div class="bg"></div>
<div class="blood" id="blood"><img src="blood.png" alt=""></div>
<div class="vignette" id="vignette"></div>
<div class="blackout" id="blackout"></div>

<header class="top">
  <div>
    <div class="h1">104th Cadet Corps — Evaluation Program</div>
    <div class="sub">Recruitment &amp; Aptitude Intake • Phase <span id="phaseNum">1</span></div>
  </div>
  <div style="display:flex;gap:10px;align-items:flex-start">
    <button class="settingsBtn" id="openSettings" title="Settings" aria-label="Settings">⚙</button>
    <button class="settingsBtn" id="openStats" title="Stats" aria-label="Stats">☰</button>
    <div class="stamp">FILE: <b>#104-INTAKE</b><br>STATUS: <b id="status">RECORDING</b></div>
  </div>
</header>

<main class="wrap">
  <div class="text">
    <span id="out"></span><span class="caret"></span>
    <div class="hint" id="hint">click / space / enter to begin</div>
  </div>
</main>

<footer class="bottom">
  <div class="box hidden" id="boxStatus">
    <div class="label"><span id="statusTitle">status</span><span class="pill" id="statusPill">locked</span></div>
    <div id="statusText" style="font-size:14px;opacity:.9;line-height:1.6"></div>
  </div>

  <div class="box hidden" id="boxText">
    <div class="label"><span id="prompt">your response</span><span class="pill" id="mode">locked</span></div>
    <div class="row">
      <input id="inp" maxlength="80" autocomplete="off" disabled>
      <button class="btn" id="send" disabled>send</button>
    </div>
  </div>

  <div class="box hidden" id="boxChoice">
    <div class="label"><span id="choiceTitle">action</span><span class="pill" id="choiceMode">phase 2</span></div>
    <div class="choices" id="choices"></div>
  </div>
</footer>

<div class="modal" id="settingsModal" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" aria-label="Settings">
    <h2><span>Settings</span><button class="close" id="closeSettings">close</button></h2>
    <div class="opt">
      <div class="row2">
        <div><div style="font-weight:900">text speed</div><small>affects typing speed + pauses.</small></div>
        <div class="sel" id="speedSel"></div>
      </div>

      <div class="row2 hidden" id="skipRow">
        <div><div style="font-weight:900">skip typing</div><small>double-tap click / space / enter to finish the current line.</small></div>
        <label class="tog"><input type="checkbox" id="skipToggle"><span style="opacity:.85">enabled</span></label>
      </div>

      <div class="row2">
        <div><div style="font-weight:900">save slot</div><small>single slot. autosaves on milestones.</small></div>
        <div class="sel">
          <button class="chip" id="btnSave" type="button">save</button>
          <button class="chip" id="btnLoad" type="button">load</button>
          <button class="chip" id="btnClear" type="button">clear</button>
        </div>
      </div>
    </div>
    <div class="note" id="settingsNote">text speed is available now. skip will unlock after you reach an ending.</div>
  </div>
</div>

<div class="modal" id="statsModal" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" aria-label="Stats">
    <h2>
      <span>Cadet Evaluation</span>
      <button class="close" id="closeStats">close</button>
    </h2>
    <div class="statsGrid" id="statsGrid"></div>
    <div class="note" id="statsNote"></div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id),clamp=(n,a,b)=>Math.max(a,Math.min(b,n)),wait=ms=>new Promise(r=>setTimeout(r,ms)),rand=(a,b)=>a+Math.random()*(b-a);
const out=$("out"),hint=$("hint"),phaseNum=$("phaseNum"),statusEl=$("status");
const boxText=$("boxText"),prompt=$("prompt"),mode=$("mode"),inp=$("inp"),send=$("send");
const boxChoice=$("boxChoice"),choiceTitle=$("choiceTitle"),choiceMode=$("choiceMode"),choicesEl=$("choices");
const blood=$("blood"),vignette=$("vignette"),blackout=$("blackout");
const boxStatus=$("boxStatus"),statusTitle=$("statusTitle"),statusPill=$("statusPill"),statusText=$("statusText");

const statsModal=$("statsModal"), openStatsBtn=$("openStats"), closeStatsBtn=$("closeStats");
const statsGrid=$("statsGrid"), statsNote=$("statsNote");

/* SKIP LOCK */
const SKIP_UNLOCK_KEY="aot_unlocked_skip_v1";
const SKIP_UNLOCKED=(localStorage.getItem(SKIP_UNLOCK_KEY)==="1");

/* settings */
const SKEY="aot_eval_settings_v1";
const settings=(()=>{try{return JSON.parse(localStorage.getItem(SKEY)||"{}")}catch{return{}}})();
settings.speed=Number(settings.speed||1); if(![1,1.5,2].includes(settings.speed)) settings.speed=1;
settings.skip = SKIP_UNLOCKED ? (typeof settings.skip==="boolean"?settings.skip:true) : false;
const saveSettings=()=>localStorage.setItem(SKEY,JSON.stringify(settings));

/* modal */
const modal=$("settingsModal"),openBtn=$("openSettings"),closeBtn=$("closeSettings");
const speedSel=$("speedSel"),skipToggle=$("skipToggle"),skipRow=$("skipRow"),settingsNote=$("settingsNote");
const btnSave=$("btnSave"),btnLoad=$("btnLoad"),btnClear=$("btnClear");
const speeds=[1,1.5,2];
const openSettings=()=>{modal.classList.add("show");modal.setAttribute("aria-hidden","false")};
const closeSettings=()=>{modal.classList.remove("show");modal.setAttribute("aria-hidden","true")};
openBtn.onclick=openSettings; closeBtn.onclick=closeSettings;
modal.addEventListener("click",e=>{if(e.target===modal) closeSettings()});
document.addEventListener("keydown",e=>{if(e.key==="Escape"&&modal.classList.contains("show")) closeSettings()});

function renderSettings(){
  speedSel.innerHTML="";
  speeds.forEach(v=>{
    const b=document.createElement("button");
    b.className="chip"+(settings.speed===v?" on":""); b.type="button"; b.textContent=v+"x";
    b.onclick=()=>{settings.speed=v;saveSettings();renderSettings()};
    speedSel.appendChild(b);
  });
  if(SKIP_UNLOCKED){
    skipRow.classList.remove("hidden");
    settingsNote.innerHTML='for replays: turn on <b>skip typing</b> + bump <b>text speed</b>.';
    skipToggle.checked=!!settings.skip;
  }else{
    skipRow.classList.add("hidden");
    settingsNote.textContent="text speed is available now. skip will unlock after you reach an ending.";
    try{skipToggle.checked=false}catch{}
  }
}
skipToggle.onchange=()=>{ if(!SKIP_UNLOCKED){skipToggle.checked=false;return} settings.skip=skipToggle.checked;saveSettings(); };
renderSettings();

/* typing + render */
const KEEP=9,DIM=2; let lines=[],cur="";
const WHO0="\uE020",WHO1="\uE021",P0="\uE010",P1="\uE011";
const W=t=>`${WHO0}INSTRUCTOR ENZO:${WHO1} ${t}`, PICK=t=>`${P0}${t}${P1}`;
const N=(name,t)=>`${WHO0}${name.toUpperCase()}:${WHO1} ${t}`;
const esc=s=>String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
const markup=s=>esc(s).replaceAll(WHO0,'<span class="who">').replaceAll(WHO1,"</span>").replaceAll(P0,'<span class="pick">').replaceAll(P1,"</span>");
const render=()=>{
  const n=lines.length,start=Math.max(0,n-(KEEP+DIM)),view=lines.slice(start);
  out.innerHTML=view.map((l,i)=>{const age=view.length-1-i,cls=age>=KEEP+1?"fade":age>=KEEP?"dim":"";return `<span class="ln ${cls}">${markup(l)}</span>`}).join("")+(cur?`<span class="ln">${markup(cur)}</span>`:"");
};
const pushLine=l=>{lines.push(l);const cap=KEEP+DIM+5;if(lines.length>cap) lines=lines.slice(lines.length-cap)};

let skipReq=false,lastAct=0,forceNoSkip=false;
function requestSkip(){
  if(!SKIP_UNLOCKED||forceNoSkip||!settings.skip) return;
  const now=performance.now();
  if(now-lastAct<320) skipReq=true;
  lastAct=now;
}
const BASE_CM=55,BASE_CX=120,sp=()=>Math.max(.25,Number(settings.speed||1));
let AC=null,typeBuf=null,subBuf=null,master=null,lastTick=0;
let subSrc=null,subGain=null,subLP=null,subComp=null;

async function initAudio(){
  if(AC) return;
  AC=new (window.AudioContext||window.webkitAudioContext)();
  master=AC.createGain(); master.gain.value=1.25; master.connect(AC.destination);
  const load=async url=>AC.decodeAudioData(await (await fetch(url)).arrayBuffer());
  [typeBuf,subBuf]=await Promise.all([load("type.mp3"),load("subbass.mp3")]);
  subGain=AC.createGain(); subLP=AC.createBiquadFilter(); subLP.type="lowpass"; subLP.frequency.value=14000; subLP.Q.value=.7;
  subComp=AC.createDynamicsCompressor(); subComp.threshold.value=-24; subComp.knee.value=30; subComp.ratio.value=6; subComp.attack.value=.01; subComp.release.value=.2;
  subGain.connect(subLP); subLP.connect(subComp); subComp.connect(master);
}
function tick(){
  if(!AC||!typeBuf) return;
  const t=AC.currentTime; if(t-lastTick<.03) return; lastTick=t;
  const src=AC.createBufferSource(); src.buffer=typeBuf;
  const len=.055,st=Math.max(0,Math.random()*(typeBuf.duration-len-.02));
  const g=AC.createGain();
  g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(.85,t+.006); g.gain.linearRampToValueAtTime(0,t+len);
  src.connect(g); g.connect(master); src.start(t,st,len);
}
function startSubbass(){
  if(!AC||!subBuf||subSrc) return;
  subSrc=AC.createBufferSource(); subSrc.buffer=subBuf; subSrc.loop=true;
  subGain.gain.value=0; subSrc.connect(subGain); subSrc.start();
}
function stopSubbass(fadeMs=500){
  if(!AC||!subSrc) return;
  const t=AC.currentTime;
  subGain.gain.cancelScheduledValues(t);
  subGain.gain.setValueAtTime(subGain.gain.value,t);
  subGain.gain.linearRampToValueAtTime(0,t+fadeMs/1000);
  const kill=subSrc; subSrc=null;
  setTimeout(()=>{try{kill.stop()}catch{}},fadeMs+50);
}
function setSubbassIntensity(x,ms=200){
  if(!AC||!subGain||!subLP) return;
  x=clamp(x,0,1);
  const t=AC.currentTime,d=ms/1000;
  const gain=0.18+0.55*x,cut=14000-12000*x,qq=0.7+2.2*x;
  subGain.gain.cancelScheduledValues(t); subGain.gain.setValueAtTime(subGain.gain.value,t); subGain.gain.linearRampToValueAtTime(gain,t+d);
  subLP.frequency.cancelScheduledValues(t); subLP.frequency.setValueAtTime(subLP.frequency.value,t); subLP.frequency.linearRampToValueAtTime(cut,t+d);
  subLP.Q.cancelScheduledValues(t); subLP.Q.setValueAtTime(subLP.Q.value,t); subLP.Q.linearRampToValueAtTime(qq,t+d);
}

/* simple BGM loops */
function mkLoop(src, vol = .6){
  const a = new Audio(src);
  a.loop = true;
  a.preload = "auto";
  a.volume = 0;
  return {
    a,
    target: vol,
    on: false,
    fadeTimer: null,
    stopTimer: null
  };
}

function fade(loop, to = .6, ms = 1400){
  const A = loop.a;
  const from = A.volume || 0;
  const steps = 24, dt = ms / steps;
  let i = 0;

  if(loop.fadeTimer) clearInterval(loop.fadeTimer);
  loop.fadeTimer = setInterval(() => {
    i++;
    const p = i / steps;
    A.volume = from + (to - from) * p;
    if(i >= steps){
      clearInterval(loop.fadeTimer);
      loop.fadeTimer = null;
    }
  }, dt);
}

async function startLoop(loop, ms = 1400){
  try{
    if(loop.stopTimer){ clearTimeout(loop.stopTimer); loop.stopTimer = null; }

    if(!loop.on){
      loop.on = true;
      loop.a.volume = 0;
      await loop.a.play();
    }
    fade(loop, loop.target, ms);
  }catch{}
}

function stopLoop(loop, ms = 900){
  if(!loop.on) return;
  if(loop.fadeTimer){ clearInterval(loop.fadeTimer); loop.fadeTimer = null; }
  fade(loop, 0, ms);
  if(loop.stopTimer) clearTimeout(loop.stopTimer);
  loop.stopTimer = setTimeout(() => {
    try{ loop.a.pause(); }catch{}
    loop.on = false;
    loop.stopTimer = null;
  }, ms + 120);
}

/* PHASE 3 DAY 1 (original) */
const d1_morning=mkLoop("dayambience.mp3",0.40);
const d1_evening=mkLoop("armyG.mp3",0.52);
const d1_night  =mkLoop("peaceful.mp3",0.55);

/* PHASE 3 DAY 2 (your new tracks ONLY) */
const d2_morning=mkLoop("morning2.mp3",0.46);
const d2_evening=mkLoop("evening2.mp3",0.52);
const d2_night  =mkLoop("night2.mp3",0.55);

function stopAllMusic(ms=900){
  [d1_morning,d1_evening,d1_night,d2_morning,d2_evening,d2_night].forEach(x=>stopLoop(x,ms));
}

/* output */
async function typeChars(str){
  for(let i=0;i<str.length;i++){
    if(SKIP_UNLOCKED && skipReq && !forceNoSkip){cur+=str.slice(i);skipReq=false;render();return}
    cur+=str[i]; tick(); render();
    await wait(rand(BASE_CM,BASE_CX)/sp());
  }
}
async function typeLine(str,gap=780){
  if(str===""){pushLine("");cur="";render();await wait(420/sp());return}
  await typeChars(str); pushLine(cur); cur=""; render();
  await wait(gap/sp());
}
async function say(arr){
  arr=Array.isArray(arr)?arr:String(arr).split("\n");
  for(const ln of arr) await typeLine(ln,650);
}

/* UI helpers */
const hideAllBoxes=()=>{boxStatus.classList.add("hidden");boxText.classList.add("hidden");boxChoice.classList.add("hidden")};
const showText=(label,pill)=>{hideAllBoxes();boxText.classList.remove("hidden");prompt.textContent=label;mode.textContent=pill;inp.disabled=send.disabled=false;inp.focus()};
const lockText=pill=>{inp.disabled=send.disabled=true;mode.textContent=pill};
const showChoices=(title,pill)=>{hideAllBoxes();boxChoice.classList.remove("hidden");choiceTitle.textContent=title;choiceMode.textContent=pill};
const showStatus=(title,pill,text)=>{hideAllBoxes();boxStatus.classList.remove("hidden");statusTitle.textContent=title;statusPill.textContent=pill;statusText.textContent=text||""};
const setStatus=s=>statusEl.textContent=s;
const clearScreen=()=>{lines=[];cur="";render()};
const clearChoices=()=>choicesEl.innerHTML="";
const setBlood=a=>blood.style.opacity=clamp(a,0,1),setVignette=a=>vignette.style.opacity=clamp(a,0,1);

/* state (NO GLOBAL META STORAGE — fixed flawless persistence) */
let started=0,locked=false,sceneId=null,q=Promise.resolve(),currentChoices=[];
let state={
  phase:1,
  name:localStorage.getItem("aot_cadet_name")||"",
  fear:0,hesitation:0,obedience:0,initiative:0,injuries:0,dead:false,
  flags:{}, rel:{}, path:{},
  flawless:true, flawlessWarn:0,
  day:1
};
const hasFlag=k=>!!(state.flags&&state.flags[k]);
const setFlag=(k,v=true)=>{state.flags=state.flags||{};state.flags[k]=v;};
const relAdd=(k,d)=>{state.rel=state.rel||{};state.rel[k]=(state.rel[k]||0)+d;};
const setPath=(k,v)=>{state.path=state.path||{};state.path[k]=v;};

/* ===== STATS SYSTEM ===== */
function fileStatus(){ if(!state.flawless) return "FLAGGED"; return (state.flawlessWarn>0) ? "UPDATED" : "CLEAN"; }
function fileStatusDesc(){ const fs=fileStatus(); if(fs==="CLEAN") return "You're ideal."; if(fs==="UPDATED") return "Still flawless, but on the verge of losing it."; return "Flawless is broken."; }
function badgeClass(fs){ return fs==="CLEAN"?"clean":fs==="UPDATED"?"updated":"flagged"; }
function band(n){ n=clamp(n,0,9); if(n<=1) return "LOW"; if(n<=4) return "ELEVATED"; if(n<=7) return "HIGH"; return "CRITICAL"; }
function renderStats(){
  const fs=fileStatus();
  const rows=[
    {k:"FILE STATUS", v:fs, cls:`badge ${badgeClass(fs)}`, s:fileStatusDesc()},
    {k:"FEAR", v:`${band(state.fear)} (${clamp(state.fear,0,9)})`, s:"Psychological stress, your mental state."},
    {k:"HESITATION", v:`${band(state.hesitation)} (${clamp(state.hesitation,0,9)})`, s:"Cadet's response delay under pressure."},
    {k:"OBEDIENCE", v:`${band(state.obedience)} (${clamp(state.obedience,0,9)})`, s:"Compliance with procedure."},
    {k:"INITIATIVE", v:`${band(state.initiative)} (${clamp(state.initiative,0,9)})`, s:"Ability to act without instruction."},
    {k:"INJURIES", v:`${clamp(state.injuries,0,9)}`, s:"Accumulated trauma markers."}
  ];
  statsGrid.innerHTML = rows.map(r=>`
    <div class="statRow">
      <div><div class="k">${r.k}</div><small>${r.s||""}</small></div>
      <div class="${r.cls||""} v">${r.v}</div>
    </div>
  `).join("");
  statsNote.textContent = (fs==="FLAGGED") ? "Record flagged for review." : "Record available. Changes are logged.";
}
function openStats(){ renderStats(); statsModal.classList.add("show"); statsModal.setAttribute("aria-hidden","false"); }
function closeStats(){ statsModal.classList.remove("show"); statsModal.setAttribute("aria-hidden","true"); }
openStatsBtn.onclick=()=>{ if(!started) return; openStats(); };
closeStatsBtn.onclick=closeStats;
statsModal.addEventListener("click",e=>{ if(e.target===statsModal) closeStats(); });
document.addEventListener("keydown",e=>{ if(e.key==="Escape" && statsModal.classList.contains("show")) closeStats(); });

/* FX */
function applyFx(fx){
  if(!fx) return;
  for(const k in fx) if(typeof fx[k]==="number" && typeof state[k]==="number") state[k]+=Number(fx[k]||0);
  state.fear=clamp(state.fear,0,9); state.hesitation=clamp(state.hesitation,0,9);
  if(fx.flag) setFlag(fx.flag,true);
  if(fx.unflag) setFlag(fx.unflag,false);
  if(fx.rel) relAdd(fx.rel.k,Number(fx.rel.d||0));
  if(fx.setPath) setPath(fx.setPath.k,fx.setPath.v);
  if(fx.warnFlawless){ state.flawlessWarn = clamp((state.flawlessWarn|0) + Number(fx.warnFlawless||1), 0, 2); }
  if(fx.breakFlawless){ state.flawless=false; state.flawlessWarn = 2; }
}

/* risk bed */
function setRisk(on){
  if(!AC) return;
  if(on){startSubbass();setSubbassIntensity(0.35,260);setVignette(0.18)}
  else{setSubbassIntensity(0,300);setVignette(0);stopSubbass(600)}
}

/* transitions (VISUALS ONLY — music handled by applyBgm) */
async function fadeToNight(){
  const prevSpeed=settings.speed,prevSkip=settings.skip;
  forceNoSkip=true;skipReq=false;settings.speed=1;settings.skip=false;
  blackout.classList.add("on"); await wait(1150);
  document.body.classList.add("night");
  blackout.classList.remove("on"); await wait(1150);
  settings.speed=prevSpeed;settings.skip=prevSkip;forceNoSkip=false;
}
async function fadeToDay(){
  const prevSpeed=settings.speed,prevSkip=settings.skip;
  forceNoSkip=true;skipReq=false;settings.speed=1;settings.skip=false;
  blackout.classList.add("on"); await wait(1050);
  document.body.classList.remove("night");
  blackout.classList.remove("on"); await wait(1050);
  settings.speed=prevSpeed;settings.skip=prevSkip;forceNoSkip=false;
}

/* ===== SAVE SLOT (single) + AUTOSAVE GATE ===== */
const SAVEKEY="aot_save_v1";
const MANUAL_LOCK_KEY="aot_manual_save_lock_v1";
let lastAutoScene=null;

function packSave(){
  return { v:2, t:Date.now(), sceneId, lines,cur, state:JSON.parse(JSON.stringify(state)) };
}
function autosaveForce(){
  if(!sceneId) return;
  try{ localStorage.setItem(SAVEKEY,JSON.stringify(packSave())); }catch{}
}
function autosave(){
  if(!sceneId) return;
  const lockedByManual = localStorage.getItem(MANUAL_LOCK_KEY)==="1";
  if(lockedByManual){
    if(sceneId!==lastAutoScene){ localStorage.removeItem(MANUAL_LOCK_KEY); }
    else return;
  }
  const scene=SCENES[sceneId];
  const major = !!scene?.end || sceneId==="field_entry" || sceneId==="p3_entry" || sceneId==="p3_night_cafeteria_intro" ||
                sceneId==="p3_d2_entry" || sceneId==="p3_d2_evening_hub" || sceneId==="p3_d2_night_hub";
  if(!major) return;
  if(sceneId===lastAutoScene) return;
  lastAutoScene=sceneId;
  autosaveForce();
}
function loadFromSnapshot(s){
  if(!s||!s.state) return false;
  state=s.state; sceneId=s.sceneId;
  lines=Array.isArray(s.lines)?s.lines:[]; cur=String(s.cur||"");
  phaseNum.textContent=String(state.phase>=3?3:state.phase>=2?2:1);
  render();
  if(sceneId && SCENES[sceneId]) applyBgm(SCENES[sceneId],true);
  return true;
}
function loadSave(){
  try{ const raw=localStorage.getItem(SAVEKEY); if(!raw) return false; return loadFromSnapshot(JSON.parse(raw)); }
  catch{return false}
}
function clearSave(){
  try{
    localStorage.removeItem(SAVEKEY);
    localStorage.removeItem(MANUAL_LOCK_KEY);
    lastAutoScene=null;
  }catch{}
}
btnSave.onclick=()=>{
  autosaveForce();
  lastAutoScene=sceneId;
  localStorage.setItem(MANUAL_LOCK_KEY,"1");
  settingsNote.textContent="saved to slot.";
};
btnLoad.onclick=()=>{ if(loadSave()){settingsNote.textContent="loaded. resuming…"; closeSettings(); enqueue(()=>goto(sceneId||"field_entry"))}else settingsNote.textContent="no save found."; };
btnClear.onclick=()=>{
  clearSave();
  state={
    phase:1,
    name:localStorage.getItem("aot_cadet_name")||"",
    fear:0,hesitation:0,obedience:0,initiative:0,injuries:0,dead:false,
    flags:{}, rel:{}, path:{},
    flawless:true, flawlessWarn:0,
    day:1
  };
  sceneId=null; lines=[]; cur=""; render();
  setStatus("RECORDING");
  settingsNote.textContent="save cleared.";
};

/* intro */
const intro=[
  {t:"Starting..",g:900},{t:"",g:450},
  {t:"104th Cadet Corps Evaluation Program.",g:900},{t:"",g:450},
  {t:"This session is recorded.",g:700},
  {t:"Respond clearly.",g:900},{t:"",g:450},
  {t:"Hesitation will be noted.",g:1100},{t:"",g:450},
  {t:"State your name.",g:700}
];

/* SCENES */
const SCENES={
/* ===== PHASE 2 (kept) ===== */
field_entry:{text:s=>[
  W("Phase 2. Field Evaluation."),
  W(`Cadet ${s.name||"—"}. You will move when told.`),
  "","You step into a training field.","Wind. Dry grass. A bell tower silhouette in the distance.",
  "A single Titan target moves between ruined frames. It has not seen you."
],title:"choose",choices:[
  {k:"A",label:"stay low. approach from debris.",fx:{obedience:+1},next:"approach_debris"},
  {k:"B",label:"sprint straight to close distance.",fx:{initiative:+1,hesitation:+1,warnFlawless:1},next:"sprint_open"},
  {k:"C",label:"wait. observe its pattern.",fx:{hesitation:+1},next:"observe"}
]},
observe:{text:()=>[
  "You hold your breath and watch.","It walks; three steps. pause. tilt head. repeat.",
  "Your legs tense. The window closes.",W("Decision. Now.")
],title:"choose",choices:[
  {k:"1",label:"approach from debris.",fx:{obedience:+1},next:"approach_debris"},
  {k:"2",label:"sprint in.",fx:{initiative:+1,hesitation:+1,warnFlawless:1},next:"sprint_open"},
  {k:"3",label:"withdraw.",fx:{hesitation:+2,breakFlawless:true},next:"end_withdrawn"}
]},
approach_debris:{text:()=>[
  W("Good. Use cover."),
  "You move between broken stone and splintered beams.","The Titan turns its head—slow. Searching.",
  "You are within striking range."
],title:"one action",choices:[
  {k:"1",label:"aim for the eyes.",fx:{initiative:+1},next:"eyes_attempt"},
  {k:"2",label:"cut the achilles.",fx:{obedience:+1},next:"ankle_attempt"},
  {k:"3",label:"back off. reposition.",fx:{hesitation:+1,warnFlawless:1},next:"reposition"}
]},
sprint_open:{text:()=>[
  W("Loud."),"You break into a sprint.","The Titan’s head snaps toward you.","It sees you.","Your stomach drops."
],title:"react",choices:[
  {k:"1",label:"zigzag toward its blind spot.",fx:{initiative:+1},next:"blindspot"},
  {k:"2",label:"keep charging. commit.",fx:{initiative:+2,fear:+1,warnFlawless:1},next:"commit_charge"},
  {k:"3",label:"abort. dive behind rubble.",fx:{obedience:+1,hesitation:+1,breakFlawless:true},next:"dive_cover"}
]},
eyes_attempt:{text:()=>[
  "You angle upward.","Your blade lines with the eye socket—","The Titan jerks.","Your timing matters."
],title:"commit",choices:[
  {k:"1",label:"strike.",fx:{initiative:+1},next:"eyes_strike"},
  {k:"2",label:"hesitate.",fx:{hesitation:+2,fear:+1,breakFlawless:true},next:"death_slow"}
]},
eyes_strike:{text:()=>[
  "Your blade lands. The Titan recoils.","The eye collapses. A wet snap.","It thrashes—blind panic on one side.",
  "Stone bursts beside you.",W("Move.")
],title:"next",choices:[
  {k:"1",label:"break contact. reset to cover.",fx:{obedience:+1},next:"end_clean"},
  {k:"2",label:"stay in. finish the damage.",fx:{initiative:+1,fear:+1,breakFlawless:true},next:"end_overcommit"}
]},
ankle_attempt:{text:()=>[
  "You drop low.","You cut. Deep.","The Titan stumbles. Not down."
],title:"follow-up",choices:[
  {k:"1",label:"get out now.",fx:{obedience:+1,warnFlawless:1},next:"end_messy"},
  {k:"2",label:"stay. keep cutting.",fx:{initiative:+1,fear:+1,breakFlawless:true},next:"death_slow"}
]},
reposition:{text:()=>[
  "You pull back.","The Titan’s head turns—searching for the movement it felt.",W("You’re bleeding time.")
],title:"choose",choices:[
  {k:"1",label:"re-engage.",fx:{initiative:+1},next:"eyes_attempt"},
  {k:"2",label:"withdraw fully.",fx:{hesitation:+2,breakFlawless:true},next:"end_withdrawn"}
]},
blindspot:{text:()=>[
  "You cut left, then right.","The Titan swings late.","You slip behind it.",W("Now.")
],title:"one action",choices:[
  {k:"1",label:"break away.",fx:{obedience:+1},next:"end_clean"},
  {k:"2",label:"go for the eyes.",fx:{initiative:+1,breakFlawless:true},next:"eyes_attempt"}
]},
commit_charge:{text:()=>[
  "You commit.","The Titan’s shadow swallows the ground.","It reaches."
],title:"last chance",choices:[
  {k:"1",label:"duck under. pass through.",fx:{initiative:+2},next:"blindspot"},
  {k:"2",label:"jump up. gamble.",fx:{fear:+2,breakFlawless:true},next:"death_gamble"}
]},
dive_cover:{text:()=>[
  "You dive behind rubble.","Dust fills your mouth.","The Titan’s fingers scrape stone.","It didn’t get you."
],title:"next",choices:[
  {k:"1",label:"crawl away. reset.",fx:{obedience:+1,warnFlawless:1},next:"approach_debris"},
  {k:"2",label:"run again.",fx:{hesitation:+1,fear:+1,breakFlawless:true},next:"sprint_open"}
]},
death_slow:{death:true,ramp:[0,.10,.18,.28,.42,.58,.72,.86,1],sub:"Hesitation will get you nowhere.",
text:()=>[
  "You hesitate.","Not long.","Just long enough.","",
  "The titan grabs you.. and the air changes.","",
  "The world snaps upward.","Your stomach drops behind you.","",
  "You try to inhale.. but nothing comes in.","Panic sets in.","",
  "Your voice tears out.","It turns into a sound you don’t recognize.","",
  "The field tilts.. and the sky smears sideways.","Your vision tunnels. Your ears start ringing.","",
  "You kick, you squirm.. but it doesn't let go.","You yell to your instructor.. but no one hears.","",
  "A calm second passes—",
  "like the world is waiting for you to stop.","",
  "Then.. silence.","",PICK("STATUS: DECEASED.")
]},
death_gamble:{death:true,ramp:[0,.10,.18,.28,.42,.58,.72,.86,1],sub:"Gamble noted. Outcome: predictable.",
text:()=>[
  "You jump.","For a second— you're weightless.","You desperately reach for height you do not have.","",
  "The titan's face meets you in the air.","A hand grabs you and it closes around your ribs.","Pressure.",
  "Your bones crack and fold.","You try to scream.","It comes out thin. Drowned.","",
  "The ground turns sideways.","Sky.. the dirt. Sky.","","You hit once.","Then again.","",
  "Your limbs stop responding.","",PICK("STATUS: DECEASED.")
]},
end_clean:{end:true,text:()=>["You disengage cleanly.","Your breathing steadies.",W("Adequate control. Minimal wasted motion."),W("Evaluation logged: PASS."),"",PICK("End of Phase 2.")]},
end_overcommit:{end:true,text:()=>["You stay in.","The Titan flails blind.","A near miss tears the air beside your face.","You grapple away late. Not graceful. Not clean.","Your legs keep moving even after you're safe.",W("You survived by momentum, not control."),W("Evaluation logged: PASS (CONDITIONAL)."),"",PICK("End of Phase 2.")]},
end_messy:{end:true,text:()=>["You disengage.","Your hands keep shaking after you stop.",W("You lived. That’s not the same as succeeding."),W("Evaluation logged: PASS (CONDITIONAL)."),"",PICK("End of Phase 2.")]},
end_withdrawn:{end:true,text:()=>["You withdraw.","The bell tower fades behind you.",W("Withdrawal is also a decision."),W("Evaluation logged: FAIL."),"",PICK("End of Phase 2.")]},

/* ===== PHASE 3 DAY 1 ===== */
p3_entry:{bgm:"d1_day",text:s=>[
  W("Phase 3. Trainee Corps."),"",
  "A barracks corridor. Boots on wood. Low lantern light.",
  "For the first time since intake, voices overlap. Low. Human.",
  W("You will integrate. You will be observed.")
],title:"you say",choices:[
  {k:"A",label:"\"…Hey.\"",fx:{obedience:+1,rel:{k:"mira",d:+1},flag:"p3_arrived"},next:"p3_morning_hub"},
  {k:"B",label:`"Name’s ${state.name||"cadet"}. Just transferred."`,fx:{initiative:+1,rel:{k:"nat",d:-1},warnFlawless:1,flag:"p3_brag"},next:"p3_morning_hub"},
  {k:"C",label:"Say nothing.",fx:{hesitation:+1,warnFlawless:1,flag:"silent"},next:"p3_morning_hub"}
]},
p3_morning_hub:{bgm:"d1_day",text:()=>[
  "Steve keeps talking to fill the air.","Mira watches like she’s deciding if you’re safe.","Nat watches like he’s deciding if you’re worth time.","",
  "Somewhere down the hall, someone drops a bucket.","The sound echoes too long.","",W("Training in one hour.")
],title:"before training",choices:[
  {k:"A",label:"Talk to Mira.",fx:{flag:"talked_mira"},next:"p3_mira_talk"},
  {k:"B",label:"Talk to Steve.",fx:{flag:"talked_steve"},next:"p3_steve_talk"},
  {k:"C",label:"Talk to Nat.",fx:{flag:"talked_nat"},next:"p3_nat_talk"},
  {k:"D",label:"Prepare quietly.",fx:{obedience:+1,flag:"quiet_morning"},next:"p3_morning_prepare"},
  {k:"E",label:"Head to the training yard.",fx:{},next:"p3_afternoon_entry"}
]},
p3_morning_prepare:{bgm:"d1_day",text:()=>[
  "You check straps. You check buckles.","You check them again.","",
  "Your hands move like they’re trying to outrun your thoughts.","",
  "Someone nearby is laughing too loudly.","Someone else is silent like stone."
],title:"you decide",choices:[
  {k:"1",label:"Go back. Talk to someone.",fx:{},next:"p3_morning_hub"},
  {k:"2",label:"Stay quiet. Keep preparing.",fx:{flag:"prepared_alone",warnFlawless:1},next:"p3_morning_prepare_2"},
  {k:"3",label:"Head out early to the yard.",fx:{obedience:+1},next:"p3_afternoon_entry"}
]},
p3_morning_prepare_2:{bgm:"d1_day",text:()=>[
  "The quiet starts to press on your ears.","Like a hand covering your mouth.","",
  "You catch your reflection in a dark window.","You look… smaller than you expected."
],title:"you do",choices:[
  {k:"A",label:"Shake it off. Rejoin the room.",fx:{},next:"p3_morning_hub"},
  {k:"B",label:"Hold onto the quiet. Let it harden.",fx:{flag:"hardened",warnFlawless:1},next:"p3_morning_hub"},
  {k:"C",label:"Go to training.",fx:{},next:"p3_afternoon_entry"}
]},

/* Mira / Steve / Nat (day 1) */
p3_mira_talk:{bgm:"d1_day",text:()=>[
  "Mira doesn’t move much when you come closer.","But she makes space anyway.","",
  N("Mira","First day always feels wrong."),
  N("Mira","Like you’re wearing someone else’s life."),
  "","She glances toward Nat, then away."
],title:"you reply",choices:[
  {k:"1",label:"\"Yeah… it feels fake.\"",fx:{rel:{k:"mira",d:+2},flag:"mira_anchor",setPath:{k:"mira",v:"anchor"}},next:"p3_mira_follow"},
  {k:"2",label:"\"I’m fine.\"",fx:{rel:{k:"mira",d:-1},warnFlawless:1,flag:"mira_shutout",setPath:{k:"mira",v:"avoid"}},next:"p3_mira_follow"},
  {k:"3",label:"\"How do you deal with people like Nat?\"",fx:{rel:{k:"mira",d:+1},flag:"asked_nat"},next:"p3_mira_nat"}
]},
p3_mira_nat:{bgm:"d1_day",text:()=>[
  N("Mira","Nat makes everything a contest."),
  N("Mira","If you let him pick what matters, you lose before you start."),
  "","She says it gently, like she’s trying not to wake something up."
],title:"you say",choices:[
  {k:"1",label:"\"So what matters?\"",fx:{rel:{k:"mira",d:+1}},next:"p3_mira_follow"},
  {k:"2",label:"\"I want him to stop.\"",fx:{warnFlawless:1,flag:"nat_fixation"},next:"p3_mira_follow"},
  {k:"3",label:"\"Noted.\"",fx:{obedience:+1},next:"p3_mira_follow"}
]},
p3_mira_follow:{bgm:"d1_day",text:()=>[
  "Mira watches your face for a second.","Like she’s checking for cracks.","",
  N("Mira","If it gets loud in your head…"),N("Mira","Find me. Okay?"),"",
  "It’s not pity.","It’s a rope."
],title:"you answer",choices:[
  {k:"A",label:"\"Okay.\"",fx:{rel:{k:"mira",d:+2},flag:"mira_rope"},next:"p3_morning_hub"},
  {k:"B",label:"\"Don’t do that.\" (push her away)",fx:{rel:{k:"mira",d:-2},warnFlawless:1,flag:"pushed_mira",setPath:{k:"mira",v:"avoid"}},next:"p3_morning_hub"},
  {k:"C",label:"\"Thanks.\" (quiet)",fx:{rel:{k:"mira",d:+1}},next:"p3_morning_hub"}
]},
p3_steve_talk:{bgm:"d1_day",text:()=>[
  "Steve leans like he’s been standing too long.","",
  N("Steve","Official welcome gift: a secret."),
  N("Steve","The stew is always worse on Mondays."),
  "","He waits for your reaction like it matters."
],title:"you reply",choices:[
  {k:"1",label:"\"That’s your secret?\"",fx:{rel:{k:"steve",d:+2},flag:"steve_friend",setPath:{k:"steve",v:"friend"}},next:"p3_steve_follow"},
  {k:"2",label:"\"Not now.\"",fx:{rel:{k:"steve",d:-1},warnFlawless:1,setPath:{k:"steve",v:"annoyed"}},next:"p3_steve_follow"},
  {k:"3",label:"\"Tell me something real.\"",fx:{rel:{k:"steve",d:+1},flag:"steve_real"},next:"p3_steve_real"}
]},
p3_steve_real:{bgm:"d1_day",text:()=>[
  "Steve blinks like you hit him lightly.","",
  N("Steve","…Real?"),N("Steve","Real is I don’t sleep much."),
  N("Steve","Real is I keep joking so nobody asks why."),"",
  "His smile tries to come back and fails halfway."
],title:"you respond",choices:[
  {k:"A",label:"\"You don’t have to perform.\"",fx:{rel:{k:"steve",d:+2},flag:"steve_seen"},next:"p3_steve_follow"},
  {k:"B",label:"\"Same.\"",fx:{rel:{k:"steve",d:+1}},next:"p3_steve_follow"},
  {k:"C",label:"Say nothing.",fx:{flag:"steve_left_hanging",warnFlawless:1},next:"p3_steve_follow"}
]},
p3_steve_follow:{bgm:"d1_day",text:()=>[
  "Steve clears his throat.","",
  N("Steve","Okay. Then I’ll be normal for ten seconds."),
  N("Steve","…You’re not alone here. Even if it feels like it."),"",
  "Ten seconds pass.","Then he smirks again like it burns to stay serious."
],title:"you say",choices:[
  {k:"A",label:"\"Thanks.\"",fx:{rel:{k:"steve",d:+1},flag:"steve_anchor"},next:"p3_morning_hub"},
  {k:"B",label:"\"Don’t go soft on me.\"",fx:{rel:{k:"steve",d:+1}},next:"p3_morning_hub"},
  {k:"C",label:"\"You’re weird.\"",fx:{rel:{k:"steve",d:+2}},next:"p3_morning_hub"}
]},
p3_nat_talk:{bgm:"d1_day",text:()=>[
  "Nat doesn’t smile when you approach.","He looks you over like equipment.","",
  N("Nat","You freeze under pressure."),N("Nat","Or you pretend you don’t."),
  N("Nat","Either way, you slow the line."),"","Steve stops talking.","Mira goes still."
],title:"you respond",choices:[
  {k:"1",label:"\"What do you want from me?\"",fx:{rel:{k:"nat",d:-2},flag:"nat_enemy",setPath:{k:"nat",v:"rival"},warnFlawless:1},next:"p3_nat_follow"},
  {k:"2",label:"\"Noted. I’ll fix it.\"",fx:{rel:{k:"nat",d:+1},flag:"nat_respect",setPath:{k:"nat",v:"respect"}},next:"p3_nat_follow"},
  {k:"3",label:"Say nothing. Hold eye contact.",fx:{flag:"nat_stared",setPath:{k:"nat",v:"owed"}},next:"p3_nat_follow"}
]},
p3_nat_follow:{bgm:"d1_day",text:()=>[
  "Nat steps closer, just enough to make it personal.","",
  N("Nat","Everybody wants to be carried."),N("Nat","Don’t make me carry you."),"",
  "He turns away like the conversation is already over."
],title:"you do",choices:[
  {k:"A",label:"Let it go.",fx:{flag:"nat_ignored"},next:"p3_morning_hub"},
  {k:"B",label:"Memorize his tone.",fx:{flag:"nat_fixated",warnFlawless:1,setPath:{k:"nat",v:"rival"}},next:"p3_morning_hub"},
  {k:"C",label:"Say one thing—quiet, sharp.",fx:{flag:"nat_poked",warnFlawless:1,rel:{k:"nat",d:-1},setPath:{k:"nat",v:"rival"}},next:"p3_nat_snap"}
]},
p3_nat_snap:{bgm:"d1_day",text:()=>[
  N("Nat","…What did you say?"),
  "He doesn’t raise his voice.","That’s the problem.","",
  "People nearby pretend they didn’t hear.","But they absolutely did."
],title:"you answer",choices:[
  {k:"1",label:"\"Nothing.\"",fx:{flag:"nat_backed"},next:"p3_morning_hub"},
  {k:"2",label:"\"I said I heard you.\"",fx:{flag:"nat_confirmed",warnFlawless:1,rel:{k:"nat",d:-2}},next:"p3_morning_hub"},
  {k:"3",label:"\"I said don’t talk to me like that.\"",fx:{flag:"nat_defied",breakFlawless:true,rel:{k:"nat",d:-3}},next:"p3_morning_hub"}
]},

/* training (day 1 evening music) */
p3_afternoon_entry:{bgm:"d1_eve",text:()=>[
  W("Trainee schedule: movement drills. balance. impact control."),
  W("You will rotate stations."),
  "","The yard is packed.","Ropes. beams. wooden dummies. chalk lines.","Every mistake is loud."
],title:"pick a station",choices:[
  {k:"A",label:"Balance line (precision).",fx:{obedience:+1,flag:"did_balance"},next:"p3_station_balance"},
  {k:"B",label:"Dummy strikes (control).",fx:{initiative:+1,flag:"did_dummies"},next:"p3_station_dummies"},
  {k:"C",label:"Partner footwork (with Nat).",fx:{flag:"did_nat_station"},next:"p3_station_nat"},
  {k:"D",label:"Assist Mira (strap check).",fx:{flag:"helped_mira",rel:{k:"mira",d:+1}},next:"p3_station_mira"},
  {k:"E",label:"Cool down / observe.",fx:{hesitation:+1,breakFlawless:true,flag:"observed_only"},next:"p3_observe_cooldown"}
]},
p3_station_balance:{bgm:"d1_eve",text:()=>[
  "A narrow beam. Chalk dust. Wind.","Your feet learn the line.","",W("Again."),W("Cleaner.")
],title:"after",choices:[
  {k:"1",label:"Push for perfect.",fx:{initiative:+1,flag:"grit"},next:"p3_evening_wrap"},
  {k:"2",label:"Stop when told.",fx:{obedience:+1},next:"p3_evening_wrap"},
  {k:"3",label:"Slip once. Laugh it off.",fx:{warnFlawless:1,flag:"slipped"},next:"p3_evening_wrap"}
]},
p3_station_dummies:{bgm:"d1_eve",text:()=>[
  "Wooden dummies stare like they understand you.","Your strikes thud. Too hard. Too soft.","",
  W("Control is mercy."),W("Mercy is speed.")
],title:"you adjust",choices:[
  {k:"1",label:"Slow down. Clean technique.",fx:{obedience:+1},next:"p3_evening_wrap"},
  {k:"2",label:"Hit harder. Prove a point.",fx:{warnFlawless:1,flag:"overhit",rel:{k:"nat",d:+1}},next:"p3_evening_wrap"},
  {k:"3",label:"Ask Steve to spot you.",fx:{rel:{k:"steve",d:+1},flag:"steve_spot"},next:"p3_evening_wrap"}
]},
p3_station_mira:{bgm:"d1_eve",text:()=>[
  "Mira’s strap is twisted. She’s trying not to panic about it.","",
  N("Mira","Sorry. It’s stupid."),"It isn’t.","","You fix it with steady hands."
],title:"you say",choices:[
  {k:"A",label:"\"Not stupid. We’ve got time.\"",fx:{rel:{k:"mira",d:+2},flag:"mira_trust"},next:"p3_evening_wrap"},
  {k:"B",label:"\"Just check it next time.\"",fx:{warnFlawless:1,rel:{k:"mira",d:-1}},next:"p3_evening_wrap"},
  {k:"C",label:"\"Don’t thank me.\" (too sharp)",fx:{warnFlawless:1,flag:"pushed_mira"},next:"p3_evening_wrap"}
]},
p3_station_nat:{bgm:"d1_eve",text:()=>[
  "Nat’s assigned as your partner.","He doesn’t greet you.","",
  N("Nat","Footwork."),N("Nat","If you trip, don’t blame the ground."),"",
  "You circle. You feint. He counters fast."
],title:"you choose",choices:[
  {k:"1",label:"Stay composed. Copy his timing.",fx:{initiative:+1,rel:{k:"nat",d:+1},flag:"did_well_vs_nat"},next:"p3_evening_wrap"},
  {k:"2",label:"Go aggressive. Force contact.",fx:{warnFlawless:1,rel:{k:"nat",d:-1},flag:"overaggressive"},next:"p3_evening_wrap"},
  {k:"3",label:"Back off. Let it end.",fx:{warnFlawless:1,rel:{k:"nat",d:-2},flag:"folded"},next:"p3_evening_wrap"}
]},
p3_observe_cooldown:{bgm:"d1_eve",text:()=>[
  "You step off to the edge of the yard.","Stretch your fingers. Roll your shoulders.","",
  "You watch other cadets fail in small ways.","A strap slips. A blade angle is wrong. A landing is too loud.","",
  "It hits you: everyone here is scared.","Some people just wear it differently."
],title:"you decide",choices:[
  {k:"A",label:"Go back in.",fx:{initiative:+1,flag:"returned"},next:"p3_afternoon_entry"},
  {k:"B",label:"Stay out longer.",fx:{hesitation:+1,breakFlawless:true,flag:"lingered"},next:"p3_evening_wrap"}
]},
p3_evening_wrap:{bgm:"d1_eve",text:()=>[
  "The sun dips behind wall stone.","People keep moving like they’re afraid to stop.","",
  W("Enough."),W("Return. Lights out soon.")
],title:"after training",choices:[
  {k:"A",label:"Go back with the group.",fx:{flag:"went_with_group"},next:"p3_lights_out"},
  {k:"B",label:"Hang back. Walk alone.",fx:{breakFlawless:true,flag:"alone_walk"},next:"p3_lights_out"}
]},
p3_lights_out:{unskippable:true,bgm:"none",text:()=>[
  "Boots down the corridor.","Lanterns sway.","",W("Lights out.")
],title:"you do",choices:[{k:"A",label:"Let it go dark.",fx:{},next:"__NIGHT_D1__"}]},

/* DAY 1 NIGHT cafeteria */
p3_night_cafeteria_intro:{unskippable:true,bgm:"d1_night",text:()=>[
  "Cafeteria noise, muted by stone.","Tin bowls. Low conversation.","",
  "Night makes people talk softer.","Night makes people tell the truth by accident."
],title:"where do you sit?",choices:[
  {k:"A",label:"Sit with Mira & Steve.",fx:{rel:{k:"mira",d:+1},flag:"sat_ms"},next:"p3_night_table_ms"},
  {k:"B",label:"Approach Nat.",req:{flag:"did_nat_station"},fx:{flag:"sat_nat"},next:"p3_night_table_nat"},
  {k:"C",label:"Eat alone.",fx:{breakFlawless:true,flag:"night_alone"},next:"p3_night_alone"}
]},
p3_night_table_ms:{bgm:"d1_night",text:()=>[
  "Mira shifts so you can sit.","Steve immediately pretends it was his idea.","",
  N("Steve","You survived day one. That’s basically a medal."),
  N("Mira","…Ignore him."),"",
  "For a minute, the stew isn’t disgusting.","Or maybe you just stop noticing."
],title:"you say",choices:[
  {k:"1",label:"\"I’m glad I’m not alone here.\"",fx:{rel:{k:"mira",d:+2},rel:{k:"steve",d:+1},flag:"night_bond"},next:"p3_night_ms_bond"},
  {k:"2",label:"\"Tell me something normal.\"",fx:{rel:{k:"steve",d:+2}},next:"p3_night_ms_normal"}
]},
p3_night_ms_bond:{bgm:"d1_night",text:()=>[
  "Steve’s grin softens like it surprised him.","",
  N("Steve","Yeah… same."),N("Steve","I hate that it matters. But it does."),"",
  "Mira slides her cup closer. A small, quiet invitation.","",
  N("Mira","If you wake up shaking, don’t pretend you didn’t."),
  "Her voice stays calm, like it’s a rule."
],title:"you answer",choices:[
  {k:"A",label:"\"Okay.\" (accept it)",fx:{rel:{k:"mira",d:+1}},next:"p3_night_end"},
  {k:"B",label:"\"I’m fine.\" (lie cleanly)",fx:{warnFlawless:1},next:"p3_night_end"},
  {k:"C",label:"\"Thanks.\" (quiet)",fx:{rel:{k:"steve",d:+1}},next:"p3_night_end"}
]},
p3_night_ms_normal:{bgm:"d1_night",text:()=>[
  "Steve looks up like he’s searching the ceiling for something safe.","",
  N("Steve","Normal is: the bread’s always hard on Tuesdays."),
  N("Steve","Normal is: somebody snores in Barracks B like a dying horse."),
  "","Mira’s mouth twitches—almost a smile.",N("Mira","He’s not wrong."),
  "","The air loosens. Just a little."
],title:"you do",choices:[
  {k:"A",label:"Laugh once. Let it count.",fx:{rel:{k:"steve",d:+1}},next:"p3_night_end"},
  {k:"B",label:"Stay. Don’t rush the quiet.",fx:{rel:{k:"mira",d:+1},rel:{k:"steve",d:+1}},next:"p3_night_end"}
]},
p3_night_table_nat:{bgm:"d1_night",text:()=>[
  "Nat doesn’t look up when you approach.","But he doesn’t tell you to leave.","",
  N("Nat","You did okay."),N("Nat","Don’t let it make you stupid."),"",
  "It’s almost… a compliment.","Almost."
],title:"you answer",choices:[
  {k:"1",label:"\"Thanks.\" (swallow it)",fx:{rel:{k:"nat",d:+2}},next:"p3_night_nat_follow"},
  {k:"2",label:"Say nothing. Sit anyway.",fx:{rel:{k:"nat",d:+1}},next:"p3_night_nat_follow"}
]},
p3_night_nat_follow:{bgm:"d1_night",text:()=>[
  "Nat eats like he’s timing himself.","Then, quietly—","",
  N("Nat","Tomorrow is worse."),
  N("Nat","If you fall behind, people stop seeing you."),
  "","That lands wrong.","Because it sounds… true."
],title:"you respond",choices:[
  {k:"A",label:"\"I won’t fall behind.\"",fx:{initiative:+1,flag:"nat_line_callback"},next:"p3_night_end"},
  {k:"B",label:"\"Why do you care?\"",fx:{warnFlawless:1,rel:{k:"nat",d:-1}},next:"p3_night_end"},
  {k:"C",label:"Leave before it gets worse.",fx:{flag:"left_nat"},next:"p3_night_end"}
]},
p3_night_alone:{bgm:"d1_night",text:()=>[
  "You sit where nobody has to look at you.","You eat fast.","",
  "Everyone’s laughter feels like it’s behind glass.",
  "Your spoon scrapes the bowl.","The sound is louder than it should be."
],title:"you do",choices:[
  {k:"A",label:"Finish and leave.",fx:{},next:"p3_night_end"},
  {k:"B",label:"Go sit with Mira & Steve after all.",fx:{rel:{k:"mira",d:+1},rel:{k:"steve",d:+1},flag:"sat_ms"},next:"p3_night_table_ms"}
]},
p3_night_end:{bgm:"d1_night",text:()=>[
  "Night settles in layers.",
  "The barracks takes your name and replaces it with breathing.",
  "",
  "Tomorrow is waiting.",
  "",
  PICK("End of Phase 3 — Day 1 (night).")
],title:"sleep",choices:[
  {k:"A",label:"Sleep.",fx:{},next:"__P3_CONTINUE_DAY2__"}
]},

/* ===== DAY 2 ENTRY / MORNING WAKE ROUTING ===== */
p3_d2_entry:{unskippable:true,bgm:"d2_day",text:()=>[
  W("Phase 3. Day 2."),
  "",
  "Morning turns the barracks back into a machine.",
  "Wood creaks. Canteens clink. Someone coughs like it hurts.",
  "",
  W("Get up. Move.")
],title:"next",choices:[
  {k:"A",label:"Continue.",fx:{},next:"p3_d2_route_wake"}
]},
p3_d2_route_wake:{bgm:"d2_day",text:()=>[""],title:"",choices:[
  {k:"A",label:"(route)",fx:{},next:"__ROUTE_WAKE__"}
]},

/* ===== MORNING SCENES ===== */
p3_d2_morning_ms_wake:{bgm:"d2_day",text:()=>[
  "A hand slaps your boot—gentle, urgent.",
  "",
  N("Steve","Wake up. Before Enzo decides to practice yelling."),
  "Mira’s already sitting up, smoothing her hair like it’s armor.",
  "",
  "Steve grins, then hesitates.",
  N("Steve","Don’t laugh.. okay? Cause I think we should know each other's full names."),
  N("Steve","I’m Steve Carrot."),
  "",
  "He waits for the reaction like it might kill him.",
  "Mira covers a smile with her sleeve."
],title:"you reply",choices:[
  {k:"A",label:"\"I won’t laugh.\" (soft)",fx:{rel:{k:"steve",d:+2},rel:{k:"mira",d:+1},flag:"learned_steve_fullname"},next:"p3_d2_morning_ms_after"},
  {k:"B",label:"\"Steve… Carrot?\" (repeat it)",fx:{rel:{k:"steve",d:+1}},next:"p3_d2_morning_ms_after"},
  {k:"C",label:"Laugh once anyway.",fx:{warnFlawless:1,rel:{k:"steve",d:-1}},next:"p3_d2_morning_ms_after"}
]},
p3_d2_morning_ms_after:{bgm:"d2_day",text:()=>[
  "Mira nudges a tin cup toward you.",
  "The water tastes like metal and sleep.",
  "",
  N("Mira","Today’s longer."),
  N("Mira","If you feel your head go loud… don’t hide."),
  "",
  "Steve points toward the hall.",
  N("Steve","Come on. We’ll move as a pack."),
  "It’s stupidly comforting."
],title:"morning",choices:[
  {k:"A",label:"Go with them.",fx:{flag:"d2_morning_with_ms"},next:"p3_d2_morning_hub"},
  {k:"B",label:"Split off. Do your own prep.",fx:{warnFlawless:1},next:"p3_d2_morning_hub"}
]},

p3_d2_morning_nat_wake:{bgm:"d2_day",text:()=>[
  "A sharp clang in the corridor.",
  "A cadet yelps.",
  "",
  N("Instructor Enzo","Do it again. Now."),
  N("Instructor Enzo","Louder. Move."),
  "",
  "Nat staggers half a step, catches himself immediately.",
  "Just enough to tell everyone; he’s not special.",
  "",
  "Nat’s eyes would flick to you when he sees you awake.",
  N("Nat","Up."),
  N("Nat","Don’t make me wait on you.")
],title:"you do",choices:[
  {k:"A",label:"Get up immediately.",fx:{obedience:+1,flag:"d2_morning_nat_sync"},next:"p3_d2_morning_hub"},
  {k:"B",label:"Watch Enzo for a second.",fx:{warnFlawless:1,flag:"d2_morning_watched_enzo"},next:"p3_d2_morning_hub"}
]},

p3_d2_morning_normal_wake:{bgm:"d2_day",text:()=>[
  "No one wakes you.",
  "You wake because the room changed shape--",
  "because everyone else is already moving.",
  "",
  "A boot hits the floor. A strap snaps tight.",
  "Somebody whispers a prayer that sounds practiced.",
  "",
  "You sit up, late by a few heartbeats."
],title:"you do",choices:[
  {k:"A",label:"Get up. Fast.",fx:{obedience:+1},next:"p3_d2_morning_hub"},
  {k:"B",label:"Stay still one more second.",fx:{hesitation:+1,warnFlawless:1},next:"p3_d2_morning_hub"}
]},

p3_d2_morning_hub:{bgm:"d2_day",text:()=>[
  "Morning briefing is short.",
  "Enzo doesn’t waste words on people he can replace.",
  "",
  W("Day 2 schedule; endurance. coordination. stress response."),
  W("You will be evaluated in motion."),
  "",
  "The yard waits like a mouth."
],title:"morning choice",choices:[
  {k:"A",label:"Stick with Mira & Steve.",req:{flag:"d2_morning_with_ms"},fx:{rel:{k:"mira",d:+1},rel:{k:"steve",d:+1}},next:"p3_d2_morning_ms_activity"},
  {k:"B",label:"Shadow Nat’s pace.",req:{flag:"sat_nat"},fx:{rel:{k:"nat",d:+1}},next:"p3_d2_morning_nat_activity"},
  {k:"C",label:"Do the morning alone.",fx:{warnFlawless:1},next:"p3_d2_morning_solo"}
]},
p3_d2_morning_ms_activity:{bgm:"d2_day",text:()=>[
  "Steve makes a game out of warming up.",
  "Counted steps. Perfect turns. Quiet jokes.",
  "",
  N("Steve","If I pass out.. can you please carry me back?"),
  N("Mira","If you pass out, I’m stepping over you."),
  "He laughs.. relieved she’s playing back.",
  "",
  "Mira checks your strap-- careful, practiced.",
  N("Mira","You’re okay. That's good."),
  "She says it like a decision."
],title:"to training",choices:[
  {k:"A",label:"Head to drills.",fx:{},next:"p3_d2_afternoon_entry"}
]},
p3_d2_morning_nat_activity:{bgm:"d2_day",text:()=>[
  "Nat warms up like a machine cranked up to the max.",
  "No wasted motion. No extra breath.",
  "",
  N("Nat","People only watch mistakes."),
  N("Nat","They don’t watch the effort we put in."),
  "",
  "He glances at you-- quick.",
  N("Nat","If you want respect, earn it where it hurts.")
],title:"to training",choices:[
  {k:"A",label:"Head to drills.",fx:{},next:"p3_d2_afternoon_entry"}
]},
p3_d2_morning_solo:{bgm:"d2_day",text:()=>[
  "You warm up alone.",
  "Your muscles complain like they’ve been betrayed.",
  "",
  "A few cadets look at you and look away.",
  "Like eye contact costs something."
],title:"to training",choices:[
  {k:"A",label:"Head to drills.",fx:{},next:"p3_d2_afternoon_entry"}
]},

/* ===== DAY 2 AFTERNOON -> EVENING HUB ===== */
p3_d2_afternoon_entry:{bgm:"d2_eve",text:()=>[
  "Endurance drills chew time into pieces.",
  "Run. Stop. Lift. Hold.",
  "",
  "The sun moves like it’s watching you fail slowly.",
  "",
  W("Again."),
  W("You will not bargain with fatigue.")
],title:"how you handle it",choices:[
  {k:"A",label:"Stay clean. Pace yourself.",fx:{obedience:+1,flag:"d2_clean_endurance"},next:"p3_d2_evening_hub"},
  {k:"B",label:"Push too hard. Prove something.",fx:{warnFlawless:1,initiative:+1,flag:"d2_overpushed"},next:"p3_d2_evening_hub"},
  {k:"C",label:"Lag behind.",fx:{hesitation:+1,breakFlawless:true,flag:"d2_lagged"},next:"p3_d2_evening_hub"}
]},

p3_d2_evening_hub:{bgm:"d2_eve",text:()=>[
  "Evening hits like a slow bruise.",
  "Your muscles don’t relax. They just… stop fighting.",
  "",
  "Cadets get assigned small work--",
  "cleaning gear, hauling water, fixing torn straps.",
  "",
  "People look for comfort the way starving people look for bread. Cause bread tastes better than key."
],title:"evening path",choices:[
  {k:"A",label:"Evening with Mira & Steve.",req:{flag:"sat_ms"},fx:{flag:"d2_path_ms"},next:"p3_d2_evening_ms"},
  {k:"B",label:"Evening with Nat.",req:{flag:"sat_nat"},fx:{flag:"d2_path_nat"},next:"p3_d2_evening_nat"},
  {k:"C",label:"Keep to yourself this evening.",fx:{warnFlawless:1},next:"p3_d2_evening_normal"}
]},

/* ===== MIRANSTEVE ===== */
p3_d2_evening_ms:{bgm:"d2_eve",text:()=>[
  "Steve would drag your shirt toward the wash line like it’s urgent.",
  "Mira follows without a word, arms full of folded cloth",
  "",
  N("Steve","Okay. Evening plan."),
  N("Steve","One, don’t get noticed"),
  N("Steve","Two, don’t get yelled at."),
  N("Steve","Anddd three, if we can, let's steal five minutes of peace."),
  "",
  "He says it like he’s joking.",
  "Mira follows without a word, arms full of folded cloth",
  "",
  "You end up scrubbing stains out of uniform sleeves.",
  "The water is cold.. to the point it stings.",
  "",
  N("Mira","Here."),
  "She passes you soap. Don't drop it.",
  "It’s the kind of caring that doesn’t ask permission.",
  "",
  "Steve leans close, his voice low.",
  N("Steve","There’s a storage room near the mess hall."),
  N("Steve","Sometimes… extra bread ends up there. I went once."),
  "",
  "Mira gives him a warning look.",
  N("Mira","Don’t get us in trouble."),
  "",
  "Steve lifts his hands. Innocent.",
  N("Steve","I said SOMETIMES.")
],title:"you respond",choices:[
  {k:"A",label:"Help with the laundry. Keep it calm.",fx:{rel:{k:"mira",d:+1},rel:{k:"steve",d:+1}},next:"p3_d2_evening_ms_laundry"},
  {k:"B",label:"Ask about Steve’s name again.",fx:{rel:{k:"steve",d:+2}},next:"p3_d2_evening_ms_name"},
  {k:"C",label:"Follow the ‘bread’ idea.",fx:{warnFlawless:1,flag:"d2_bread_attempt"},next:"p3_d2_evening_ms_bread"}
]},
p3_d2_evening_ms_laundry:{bgm:"d2_eve",text:()=>[
 "You scrub until your fingers go numb.",
"The work is stupidly grounding.",
"",
"The cold water bites at your skin.",
"It hurts just enough to keep you present.",
"",
"Mira hums something under her breath… barely audible.",
"Not a song you recognize.",
"Just… a pattern she keeps returning to.",
"",
N("Mira","It helps."),
N("Mira","If you give your head something small to hold."),
"",
"Steve wrings out a shirt too hard and water splashes his face.",
"He jerks back like he’s been attacked.",
N("Steve","Hey-! I’m being assaulted."),
"",
"Mira giggles.",
"A real one.",
"Quick, surprised, like it escaped by accident.",
"",
"Steve freezes for half a second.",
"Like he’s afraid to scare it away.",
"",
"For a moment, nobody talks.",
"The sound of water fills the space.",
"",
"For a second, the Trainee Corps doesn’t feel like a trap."
],title:"next",choices:[
  {k:"A",label:"Head back inside together.",fx:{rel:{k:"mira",d:+1},rel:{k:"steve",d:+1}},next:"p3_d2_night_hub"}
]},
p3_d2_evening_ms_name:{bgm:"d2_eve",text:()=>[
  "Steve keeps glancing away like the name still embarrasses him.",
"Like saying it out loud made it heavier.",
"",
N("Steve","It’s not even funny."),
N("Steve","My dad thought it was hilarious."),
"",
N("Steve","He said, ‘If you’re gonna be scared of dying--"),
N("Steve","at least have a name people remember.’"),
"",
"He shrugs like it doesn’t matter.",
"It absolutely does.",
"",
"Mira’s eyes soften.",
"She doesn’t rush to fill the silence.",
"",
N("Mira","It’s a good name… Steve.. the Carrot."),
N("Mira","I think it suits you."),
"",
"Steve blinks at that.",
"Like the words hit harder than he expected.",
"",
N("Steve","…Thanks."),
"",
"His voice goes small for one second.",
"Then he clears his throat.",
"Straightening his shoulders..",
"",
"He puts the mask back on.",
"But slower this time."
],title:"next",choices:[
  {k:"A",label:"\"I’ll remember it.\" (simple)",fx:{rel:{k:"steve",d:+2}},next:"p3_d2_night_hub"},
  {k:"B",label:"\"You don’t have to joke all the time.\" ",fx:{rel:{k:"steve",d:+2},flag:"d2_steve_seen"},next:"p3_d2_night_hub"}
]},
p3_d2_evening_ms_bread:{bgm:"d2_eve",text:()=>[
  "You follow Steve down a side corridor.",
  "He tiptoes beautifully.. better than any ballet dancer.",
  "",
  "A door. A latch. A narrow crack of darkness.",
  "",
  "Mira pauses.",
  N("Mira","If Enzo catches you.. forget we know each other okay?"),
  "",
  "Steve opens the door half an inch--",
  "and immediately freezes.",
  "",
  "Footsteps.",
  "Not hurried. Not lost.",
  "Someone who knows exactly where they’re going.",
  "",
  N("Steve","…Abort mission. Black flare."),
  "You slide away like you were never there.",
  "Your heart takes an extra second to stop sprinting."
],title:"next",choices:[
  {k:"A",label:"Back off. Return quietly.",fx:{obedience:+1},next:"p3_d2_night_hub"},
  {k:"B",label:"Laugh it off.",fx:{warnFlawless:1},next:"p3_d2_night_hub"}
]},

/* ===== EXPANDED DAY 2 EVENING — NAT ===== */
p3_d2_evening_nat:{bgm:"d2_eve",text:()=>[
  "Nat doesn’t invite you.",
  "He just… starts walking, and you either follow or you don’t.",
  "",
  "He takes you to a quiet corner of the yard where the light dies early.",
  "A crate of gear sits there like it’s waiting to be judged.",
  "",
  N("Nat","Maintenance."),
  N("Nat","If your equipment fails, you'll die like an idiot. My brother taught me that."),
  "",
  "He hands you a cloth. Then another. Then a small tin of oil.",
  "It feels almost domestic-- until you remember it’s for killing.",
  "",
  "Nat works fast, precise.",
  "His fingers are nicked in old places.",
  "",
  N("Nat","You heard what I said last night. Right?"),
  N("Nat","About falling behind."),
  "",
  "He doesn’t look up when he says it.",
  "Like eye contact would soften it."
],title:"you answer",choices:[
  {k:"A",label:"\"I heard you.\" (no excuses)",fx:{rel:{k:"nat",d:+2},flag:"d2_nat_trust"},next:"p3_d2_evening_nat_more"},
  {k:"B",label:"\"You talk like you’ve been left behind.\" ",fx:{warnFlawless:1,rel:{k:"nat",d:-1}},next:"p3_d2_evening_nat_more"},
  {k:"C",label:"Stay quiet. Keep working.",fx:{rel:{k:"nat",d:+1}},next:"p3_d2_evening_nat_more"}
]},
p3_d2_evening_nat_more:{bgm:"d2_eve",text:()=>[
  "Nat oils the hinge of a blade.",
  "The metal squeaks once, then goes silent.",
  "",
  N("Nat","I had a brother."),
  "The words come out flat. Practiced.",
  N("Nat","Scouting Legion took him outside the walls. An expedition."),
  N("Nat","They brought back a report and a piece of cloth with his name."),
  "",
  "He wipes his hands like he’s wiping the memory off.",
  "",
  N("Nat","So yeah."),
  N("Nat","I don’t like watching people fall behind."),
  N("Nat","Because you don’t come back from it."),
  "",
  "He finally looks at you.",
  "Not warm. But… direct.",
  "",
  N("Nat","You can be useful."),
  N("Nat","Or you can be another shadow.")
],title:"choose",choices:[
  {k:"A",label:"\"Tell me what to do.\" (earn it)",fx:{obedience:+1,rel:{k:"nat",d:+2}},next:"p3_d2_evening_nat_tasks"},
  {k:"B",label:"\"I’ll do it my way.\" (controlled)",fx:{initiative:+1,rel:{k:"nat",d:+1},warnFlawless:1},next:"p3_d2_evening_nat_tasks"},
  {k:"C",label:"\"I’m not your project.\" ",fx:{breakFlawless:true,rel:{k:"nat",d:-2}},next:"p3_d2_evening_nat_tasks"}
]},
p3_d2_evening_nat_tasks:{bgm:"d2_eve",text:()=>[
  "Nat sets a small list like he’s assigning shifts:",
  "",
  N("Nat","Run the perimeter once."),
  N("Nat","Then back here."),
  N("Nat","If you’re still standing, we're gonna talk."),
  "",
  "It’s a test.",
  "It’s always a test.",
  "",
  "You run until your lungs feel thin.",
  "You come back with your throat burning.",
  "",
  "Nat nods like he expected it.",
  N("Nat","Good."),
  "",
  "He sits on the crate.. like he owns the quiet."
],title:"evening talk",choices:[
  {k:"A",label:"Sit. Hear him out.",fx:{rel:{k:"nat",d:+1}},next:"p3_d2_night_branch_talk"},
  {k:"B",label:"Leave before it gets personal.",fx:{warnFlawless:1},next:"p3_d2_night_hub"}
]},

p3_d2_evening_normal:{bgm:"d2_eve",text:()=>[
  "You do the assigned work.",
  "Quietly. Efficiently.",
  "",
  "Nobody bothers you.",
  "That’s either peace or a warning."
],title:"night",choices:[
  {k:"A",label:"Head to night.",fx:{},next:"p3_d2_night_hub"}
]},

/* ===== DAY 2 NIGHT HUB ===== */
p3_d2_night_hub:{bgm:"d2_night",text:()=>[
  "Night again.",
  "Different from yesterday.",
  "Heavier-- because now you know what tomorrow costs.",
  "",
  "People whisper. Someone laughs too loud. Someone prays too hard."
],title:"night choice",choices:[
  {k:"A",label:"Stay with Mira & Steve.",req:{flag:"sat_ms"},fx:{},next:"p3_d2_night_ms"},
  {k:"B",label:"Find Nat.",req:{flag:"sat_nat"},fx:{},next:"p3_d2_night_nat"},
  {k:"C",label:"Sleep early.",fx:{},next:"p3_d2_end"}
]},
p3_d2_night_ms:{bgm:"d2_night",text:()=>[
  "Mira and Steve make room for you.",
  "",
  "Steve throws a rolled sock at Mira’s shoulder.",
  "She catches it without looking.",
  "",
  N("Steve","Alright. New rule."),
  N("Steve","If today sucked, we’re allowed one stupid thing."),
  "",
  "Mira’s eyes meet yours.",
  N("Mira","Only if you want."),
  "",
  "Steve grins.",
  N("Steve","Pillow fight. Winner gets the good corner of the mattress!")
],title:"you choose",choices:[
  {k:"A",label:"Join the pillow fight.",fx:{rel:{k:"mira",d:+1},rel:{k:"steve",d:+2},flag:"d2_pillowfight"},next:"p3_d2_night_ms_pillow"},
  {k:"B",label:"Stay close, just watch.",fx:{rel:{k:"mira",d:+1}},next:"p3_d2_end"}
]},
p3_d2_night_ms_pillow:{bgm:"d2_night",text:()=>[
  "It starts quietly..",
  "then turns into chaos.",
  "",
  "A pillow smacks your ear.",
  "You swing back on instinct.",
  "Steve yelps like he’s been stabbed.",
  "",
  "Mira laughs.",
  "A real laugh.",
  "The kind that proves she’s still here.",
  "",
  "For two minutes you forget about the horrors of the outside walls.",
  "For two minutes you feel like a person again."
],title:"sleep",choices:[
  {k:"A",label:"Sleep.",fx:{},next:"p3_d2_end"}
]},
p3_d2_night_nat:{bgm:"d2_night",text:()=>[
  "Nat sits where the lantern light doesn’t reach.",
  "He pats the space beside him once.",
  "",
  N("Nat","Question."),
  N("Nat","What branch are you interested in joining?")
],title:"choose branch",choices:[
  {k:"A",label:"Scouting Legion.",fx:{flag:"branch_sl"},next:"p3_d2_night_nat_sl"},
  {k:"B",label:"Stationary Guard.",fx:{flag:"branch_garrison"},next:"p3_d2_night_nat_gar"},
  {k:"C",label:"Military Police.",fx:{flag:"branch_mp"},next:"p3_d2_night_nat_mp"}
]},
p3_d2_night_nat_sl:{bgm:"d2_night",text:()=>[
  "Nat exhales through his nose.",
  "",
  N("Nat","The Scouting Legion…"),
  N("Nat","I lost my brother to those fucking Titans."),
  N("Nat","And I’ve been following in his footsteps to avenge him."),
  "",
  "He looks at you like he’s measuring something..",
  N("Nat","If that’s your path… I’ll follow you in it."),
  N("Nat","We can be buddies on the battlefield. Slay every goddamn titan."),
  "",
  "The word ‘buddies’ sounds wrong in his mouth.",
  "That’s how you know he means it."
],title:"sleep",choices:[{k:"A",label:"Sleep.",fx:{rel:{k:"nat",d:+2},flag:"nat_bonded"},next:"p3_d2_end"}]},
p3_d2_night_nat_gar:{bgm:"d2_night",text:()=>[
  "Nat tilts his head—considering.",
  "",
  N("Nat","Stationary Guard."),
  N("Nat","Safe. Compared to the rest."),
  N("Nat","But don’t confuse safe with easy."),
  "",
  "He taps the floor once.",
  N("Nat","If that’s where you go…"),
  N("Nat","I won’t judge you for living."),
  "",
  "It’s the closest thing to approval you’ve heard from him."
],title:"sleep",choices:[{k:"A",label:"Sleep.",fx:{rel:{k:"nat",d:+1}},next:"p3_d2_end"}]},
p3_d2_night_nat_mp:{bgm:"d2_night",text:()=>[
  "Nat’s mouth twitches like he’s suppressing a reaction.",
  "",
  N("Nat","Military Police, eh..?"),
  N("Nat","You’ll need to graduate flawlessly."),
  "",
  "His eyes flick to your face sharp.",
  N("Nat","But I’ll follow you there…"),
  N("Nat","If we both make it."),
  "",
  "For once, the ambition sounds like a promise, not a dare."
],title:"sleep",choices:[{k:"A",label:"Sleep.",fx:{rel:{k:"nat",d:+2}},next:"p3_d2_end"}]},

p3_d2_end:{end:true,bgm:"d2_night",text:()=>[
  "Night folds over you.",
  "Your body gives up first.",
  "Your mind follows later.",
  "",
  PICK("End of Phase 3 — Day 2.")
]}
};

/* ===== music router (global tag; do NOT reset in goto) ===== */
let currentBgmTag=null;

function ensureLoop(loop, ms=1200){
  if(loop.on){ fade(loop, loop.target, ms); return; }
  startLoop(loop, ms);
}

function applyBgm(scene, force=false){
  const tag = scene && scene.bgm;
  if(!tag) return;

  if(!force && currentBgmTag === tag) return;
  currentBgmTag = tag;

  if(tag === "none"){
    stopAllMusic(600);
    return;
  }

  stopAllMusic(250);

  if(tag==="d1_day"){ document.body.classList.remove("night"); ensureLoop(d1_morning,1200); }
  if(tag==="d1_eve"){ document.body.classList.remove("night"); ensureLoop(d1_evening,1200); }
  if(tag==="d1_night"){ document.body.classList.add("night"); ensureLoop(d1_night,1200); }

  if(tag==="d2_day"){ document.body.classList.remove("night"); ensureLoop(d2_morning,1200); }
  if(tag==="d2_eve"){ document.body.classList.remove("night"); ensureLoop(d2_evening,1200); }
  if(tag==="d2_night"){ document.body.classList.add("night"); ensureLoop(d2_night,1200); }
}

/* ===== choices / hotkeys (typing-safe) ===== */
function renderChoices(scene){
  clearChoices(); if(scene.death||scene.end) return;
  const raw=scene.choices||[];
  currentChoices=raw.filter(c=>checkReq(c.req));
  const hasDeath=currentChoices.some(c=>SCENES[c.next]?.death);
  setRisk(!!hasDeath);
  showChoices(scene.title||"action","phase "+(state.phase||2));
  currentChoices.forEach((c,idx)=>{
    const b=document.createElement("button");
    b.className="btn choice"; b.type="button";
    b.innerHTML=`<span>${c.k}. ${c.label}</span>`;
    b.onclick=()=>pick(idx);
    choicesEl.appendChild(b);
  });

  document.onkeydown=e=>{
    if(statsModal.classList.contains("show")) return;
    if(locked||modal.classList.contains("show")) return;

    const ae=document.activeElement;
    if(ae===inp || (ae && (ae.tagName==="INPUT"||ae.tagName==="TEXTAREA"||ae.isContentEditable))) return;

    const key=e.key.toUpperCase();
    const i=currentChoices.findIndex(x=>String(x.k).toUpperCase()===key);
    if(i>=0){e.preventDefault();pick(i)}
  };
}
const checkReq=req=>{
  if(!req) return true;
  if(req.flag && !hasFlag(req.flag)) return false;
  if(req.nflag && hasFlag(req.nflag)) return false;
  if(req.rel){const cur=(state.rel&&state.rel[req.rel.k])||0; if(cur < (req.rel.min??0)) return false;}
  if(req.flawless && !state.flawless) return false;
  return true;
};

/* death */
async function runDeath(scene){
  setRisk(false); startSubbass(); setSubbassIntensity(0.10,120);
  const prevSpeed=settings.speed,prevSkip=settings.skip;
  forceNoSkip=true;skipReq=false;settings.speed=1;settings.skip=false;
  setStatus("DECEASED"); state.dead=true; locked=true;
  showStatus("status","deceased",scene.sub||"Evaluation terminated.");
  const oldBT=blood.style.transition,oldVT=vignette.style.transition;
  blood.style.transition="opacity .12s linear"; vignette.style.transition="opacity .12s linear";
  const ramp=scene.ramp||[0,.25,.5,.75,1];
  setBlood(ramp[0]??0); setVignette(.35);
  const seq=(typeof scene.text==="function"?scene.text(state):scene.text);
  for(let i=0;i<seq.length;i++){
    const p=seq.length<=1?1:i/(seq.length-1);
    const bloodA=ramp[Math.min(i,ramp.length-1)] ?? (0.9*p);
    setBlood(bloodA);
    const intensity=clamp(p*p*1.05,0,1);
    setSubbassIntensity(intensity,180);
    setVignette(0.25+0.55*intensity);
    await typeLine(seq[i],650);
  }
  setSubbassIntensity(0,120); stopSubbass(250);
  blood.style.transition=oldBT; vignette.style.transition=oldVT;
  settings.speed=prevSpeed; settings.skip=prevSkip; forceNoSkip=false;
}

/* navigation */
async function goto(id){
  if(id==="__ROUTE_WAKE__"){
    if(hasFlag("sat_ms")) id="p3_d2_morning_ms_wake";
    else if(hasFlag("sat_nat")) id="p3_d2_morning_nat_wake";
    else id="p3_d2_morning_normal_wake";
  }

  sceneId=id;
  const scene=SCENES[id];
  if(!scene) return;

  autosave();

  locked=true; clearChoices();
  if(scene.death){ await runDeath(scene); return; }

  setBlood(0); setVignette(0); hideAllBoxes();

  applyBgm(scene);

  const prevForce=forceNoSkip,prevSkip=settings.skip,prevSpeed=settings.speed;
  if(scene.unskippable){ forceNoSkip=true;skipReq=false;settings.speed=1;settings.skip=false; }

  await say(["",...(typeof scene.text==="function"?scene.text(state):scene.text)]);

  if(scene.unskippable){ settings.speed=prevSpeed;settings.skip=prevSkip;forceNoSkip=prevForce; }

  if(scene.end){
    setRisk(false);
    setStatus("LOGGED");
    showStatus("status","logged","Logged.");
    autosave();
    locked=true;
    return;
  }

  renderChoices(scene);
  autosave();
  locked=false;
}

/* pick */
function pick(i){
  const scene=SCENES[sceneId];
  if(!scene||locked) return;
  const c=currentChoices[i];
  if(!c) return;

  locked=true;
  enqueue(async()=>{
    await say(["",PICK(`> ${c.k}. ${c.label}`)]);
    applyFx(c.fx);

    if(c.next==="__NIGHT_D1__"){
      await wait(650);
      await fadeToNight();                 // visuals only
      await goto("p3_night_cafeteria_intro"); // scene bgm starts d1_night
      return;
    }

    if(c.next==="__P3_CONTINUE_DAY2__"){
      setRisk(false);
      setStatus("LOGGED");
      showStatus("status","logged","Phase 3 — Day 1 complete.\nType: continue");
      state.phase = 3.25;
      showText("type: continue","awaiting");
      locked=false;
      return;
    }

    if(c.next) await goto(c.next);
  });
}

/* flow */
const enqueue=fn=>(q=q.then(fn).catch(()=>{}));

async function runIntro(){ for(const x of intro) await typeLine(x.t,x.g); showText("your response","phase 1"); }

async function enterPhase2(){
  state.phase=2; phaseNum.textContent="2"; setStatus("RECORDING");
  document.body.classList.remove("night");
  stopAllMusic(250);
  setBlood(0); setVignette(0); setRisk(false); state.dead=false; locked=false;
  clearScreen();
  await goto("field_entry");
}
async function enterPhase3(){
  state.phase=3; phaseNum.textContent="3"; setStatus("RECORDING");
  state.day=1;
  document.body.classList.remove("night");
  stopAllMusic(250);
  setBlood(0); setVignette(0); setRisk(false); state.dead=false; locked=false;
  clearScreen();
  await goto("p3_entry");
}

function start(){
  if(started) return;
  started=1; hint.classList.add("hidden");
  document.removeEventListener("click",start);
  document.removeEventListener("keydown",keyStart);
  initAudio().then(()=>enqueue(runIntro));
}
function keyStart(e){ if(e.key===" "||e.key==="Enter"){e.preventDefault();start();} }
document.addEventListener("click",start);
document.addEventListener("keydown",keyStart);

/* skip interactions */
document.addEventListener("pointerdown",()=>{ if(started&&!modal.classList.contains("show") && !statsModal.classList.contains("show")) requestSkip(); },{passive:true});
document.addEventListener("keydown",e=>{ if(!started||modal.classList.contains("show")||statsModal.classList.contains("show")) return; if(e.key===" "||e.key==="Enter") requestSkip(); });

/* input */
send.addEventListener("click",()=>{
  const v=inp.value.trim(); if(!v) return; inp.value="";
  if(state.phase===1){
    lockText("processing");
    state.name=v; localStorage.setItem("aot_cadet_name",v);
    enqueue(async()=>{
      await say(["","Name received: "+v,"Noted.","Profile initialized.","","Proceed when ready."]);
      showText("type: proceed","awaiting");
      state.phase=1.5;
    });
    return;
  }
  if(state.phase===1.5){
    if(v.toLowerCase()!=="proceed"){enqueue(()=>say(["","Command rejected.","Type: proceed"]));return}
    lockText("loading");
    enqueue(async()=>{ await say(["","Acknowledged.","Loading evaluation module…",""]); await enterPhase2(); });
    return;
  }
  if(state.phase===2.5){
    if(v.toLowerCase()!=="continue"){enqueue(()=>say(["","Command rejected.","Type: continue"]));return}
    lockText("loading");
    enqueue(async()=>{ await say(["","Acknowledged.","Proceeding to trainee corps…",""]); await enterPhase3(); });
    return;
  }
  if(state.phase===3.25){
    if(v.toLowerCase()!=="continue"){enqueue(()=>say(["","Command rejected.","Type: continue"]));return}
    lockText("loading");
    enqueue(async()=>{
      await say(["","Acknowledged.","Proceeding to Phase 3 — Day 2…",""]);
      state.day=2;
      await fadeToDay();       // visuals only
      await goto("p3_d2_entry"); // scene bgm starts d2_day
    });
    return;
  }
});
inp.addEventListener("keydown",e=>{ if(e.key==="Enter") send.click(); });

/* phase 2 end -> prompt continue into phase 3 */
const _goto=goto;
goto=async function(id){
  await _goto(id);
  const scene=SCENES[id];
  if(scene && scene.end && state.phase===2){
    showStatus("status","logged","Phase 2 complete.\nType: continue");
    state.phase=2.5;
    showText("type: continue","awaiting");
    locked=false;
  }
};

/* boot */
(function(){ render(); })();
</script>
</body></html>
